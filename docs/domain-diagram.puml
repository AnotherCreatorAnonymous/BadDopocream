@startuml Bad_Dopo_Cream_Domain

' ============================================
' DIAGRAMA DE CLASES DEL DOMINIO
' Bad Dopo Cream - DOPO 2025
' ============================================

skinparam classAttributeIconSize 0
skinparam backgroundColor #FEFEFE
skinparam class {
    BackgroundColor<<abstract>> LightYellow
    BorderColor Black
    ArrowColor Black
}

' ============================================
' CLASE PRINCIPAL DEL JUEGO
' ============================================

class BadDopoCream {
    - levels: ArrayList<Level>
    - currentLevelIndex: int
    - currentLevel: Level
    - totalScore: int
    - gameWon: boolean
    + BadDopoCream()
    + startGame(): void
    + nextLevel(): void
    + getCurrentLevel(): Level
    + getCurrentLevelNumber(): int
    + getTotalScore(): int
    + isGameWon(): boolean
    + isGameOver(): boolean
    + resetToLevel(levelNumber: int): void
    + restoreFromState(state: GameState): void
    + setTotalScore(score: int): void
}

' ============================================
' NIVEL Y MAPA
' ============================================

class Level {
    - levelNumber: int
    - map: Map
    - player: IceCream
    - player2: IceCream
    - fruits: ArrayList<Fruit>
    - enemies: ArrayList<Enemy>
    - isCompleted: boolean
    - currentScore: int
    - levelStartTime: long
    - pausedTime: long
    - isPaused: boolean
    - timeExpired: boolean
    {static} - LEVEL_TIME_LIMIT: long
    + Level(levelNumber: int, width: int, height: int)
    + movePlayer(dx: int, dy: int): boolean
    + movePlayer2(dx: int, dy: int): boolean
    + moveEnemies(): void
    + moveFruits(): void
    + createIceLine(dx: int, dy: int): void
    + breakIceWall(location: Location): void
    + isCompleted(): boolean
    + isGameOver(): boolean
    + getRemainingTime(): long
    + pause(): void
    + resume(): void
    + getIceWallAt(location: Location): IceWall
}

class Map {
    - width: int
    - height: int
    - walls: ArrayList<Location>
    - iceWalls: ArrayList<IceWall>
    - hotTiles: ArrayList<BaldosaCaliente>
    - campfires: ArrayList<Fogata>
    + Map(width: int, height: int)
    + isValidPosition(location: Location): boolean
    + hasWall(location: Location): boolean
    + hasIceWall(location: Location): boolean
    + isHotTile(location: Location): boolean
    + addWall(location: Location): void
    + addIceWall(location: Location): void
    + removeIceWall(location: Location): void
    + addHotTile(hotTile: BaldosaCaliente): void
    + addCampfire(campfire: Fogata): void
    + getCampfireAt(location: Location): Fogata
    + getIceWallAt(location: Location): IceWall
}

class Location {
    - x: int
    - y: int
    + Location(x: int, y: int)
    + getX(): int
    + getY(): int
    + move(dx: int, dy: int): Location
    + distanceTo(other: Location): double
    + equals(obj: Object): boolean
}

' ============================================
' JUGADOR
' ============================================

class IceCream {
    - location: Location
    - character: String
    - alive: boolean
    + IceCream(location: Location, character: String)
    + move(dx: int, dy: int): void
    + getLocation(): Location
    + setLocation(location: Location): void
    + isAlive(): boolean
    + die(): void
    + getCharacter(): String
}

class IceCreamAI {
    - game: BadDopoCream
    - level: Level
    - player: IceCream
    - profile: AIProfile
    {static} - ENEMY_DETECTION_RANGE: double
    {static} - ENEMY_DANGER_RANGE: double
    {static} - FEARFUL_SAFE_DISTANCE: double
    + IceCreamAI()
    + IceCreamAI(profile: AIProfile)
    + decideMove(): String
    - decideHungryMove(): String
    - decideFearfulMove(): String
    - decideExpertMove(): String
    - findNearestFruit(): Fruit
    - findSafestFruit(): Fruit
    - findOptimalFruit(): Fruit
    - isSafeFromEnemies(location: Location): boolean
    - canBlockEnemyWithIce(): boolean
}

enum AIProfile {
    HUNGRY
    FEARFUL
    EXPERT
}

' ============================================
' FRUTAS (JERARQUÍA)
' ============================================

abstract class Fruit {
    # name: String
    # points: int
    # location: Location
    # collected: boolean
    # canMove: boolean
    + Fruit(name: String, points: int, location: Location, canMove: boolean)
    + collect(): int
    + isCollected(): boolean
    + getLocation(): Location
    + getName(): String
    + move(): void
    + update(): void
    + canMove(): boolean
    + pushByPlayer(dx: int, dy: int, playerLocation: Location): void
    + shouldKillPlayer(playerLocation: Location): boolean
    + requiresMapReference(): boolean
}

class Banana {
    {static} - BANANA_POINTS: int = 50
    + Banana(location: Location)
}

class Cherry {
    {static} - CHERRY_POINTS: int = 100
    - map: Map
    - moveTimer: int
    - moveInterval: int
    + Cherry(location: Location)
    + setMap(map: Map): void
    + update(): void
    - findRandomValidMove(): Location
}

class Grapes {
    {static} - GRAPES_POINTS: int = 150
    + Grapes(location: Location)
}

class Pineapple {
    {static} - PINEAPPLE_POINTS: int = 200
    - map: Map
    + Pineapple(location: Location)
    + setMap(map: Map): void
    + pushByPlayer(dx: int, dy: int, playerLocation: Location): void
}

class Cactus {
    {static} - CACTUS_POINTS: int = 300
    {static} - SPIKE_DAMAGE_RANGE: double = 1.5
    - hasSpikes: boolean
    - spikeTimer: int
    - spikeInterval: int
    + Cactus(location: Location)
    + update(): void
    + shouldKillPlayer(playerLocation: Location): boolean
    + hasSpikes(): boolean
}

' ============================================
' ENEMIGOS (JERARQUÍA)
' ============================================

abstract class Enemy {
    # location: Location
    # name: String
    + Enemy(location: Location, name: String)
    + getLocation(): Location
    + setLocation(location: Location): void
    + getName(): String
    + collidesWithPlayer(playerLocation: Location): boolean
    + tryMove(playerLocation: Location, map: Map): void
    {abstract} + move(playerLocation: Location, map: Map): void
}

class Maceta {
    - dx: int
    - dy: int
    + Maceta(location: Location)
    + move(playerLocation: Location, map: Map): void
}

class Troll {
    - dx: int
    - dy: int
    {static} - TROLL_DETECTION_RANGE: double = 5.0
    + Troll(location: Location)
    + move(playerLocation: Location, map: Map): void
    + changeDirectionOnEnemyCollision(map: Map): void
}

class CalamarNaranja {
    - dx: int
    - dy: int
    - chaseMode: boolean
    {static} - DETECTION_RANGE: double = 6.0
    + CalamarNaranja(location: Location)
    + move(playerLocation: Location, map: Map): void
    - chasePlayer(playerLocation: Location, map: Map): void
    - findAlternativePath(targetX: int, targetY: int, map: Map): void
    + changeDirectionRandomly(): void
}

class Calamar {
    + Calamar(location: Location)
    + move(playerLocation: Location, map: Map): void
}

class Narval {
    + Narval(location: Location)
    + move(playerLocation: Location, map: Map): void
}

' ============================================
' OBSTÁCULOS
' ============================================

class IceWall {
    - location: Location
    - isBroken: boolean
    + IceWall(location: Location)
    + breakWall(): void
    + isBroken(): boolean
    + getLocation(): Location
    + isAt(location: Location): boolean
}

class BaldosaCaliente {
    - location: Location
    - active: boolean
    + BaldosaCaliente(location: Location)
    + getLocation(): Location
    + isActive(): boolean
    + shouldMeltIce(iceLocation: Location): boolean
}

class Fogata {
    - location: Location
    - lit: boolean
    - extinguishTime: long
    {static} - RELIGHT_DELAY: long = 10000
    + Fogata(location: Location)
    + getLocation(): Location
    + isLit(): boolean
    + extinguish(): void
    + forceRelight(): void
    + shouldKillPlayer(playerLocation: Location): boolean
}

' ============================================
' BUILDERS Y CONFIGURADORES
' ============================================

class LevelBuilder {
    {static} + buildLevel(levelNumber: int, config: LevelConfigurator): Level
    {static} - addObstacles(level: Level, map: Map, config: LevelConfigurator): void
    {static} - addFruits(level: Level, map: Map, config: LevelConfigurator): void
    {static} - addEnemies(level: Level, map: Map, config: LevelConfigurator): void
    {static} - getRandomEmptyLocation(map: Map, occupiedLocations: ArrayList<Location>): Location
}

class LevelConfigurator {
    - levelNumber: int
    - mapWidth: int
    - mapHeight: int
    - numBananas: int
    - numCherries: int
    - numGrapes: int
    - numPineapples: int
    - numCactus: int
    - numWalls: int
    - numHotTiles: int
    - numCampfires: int
    - numMacetas: int
    - numTrolls: int
    - numCalamares: int
    - playerStartX: int
    - playerStartY: int
    + LevelConfigurator(levelNumber: int)
    + {static} getDefaultConfiguration(levelNumber: int): LevelConfigurator
    + setMapSize(width: int, height: int): LevelConfigurator
    + setFruits(bananas: int, cherries: int, grapes: int, pineapples: int, cactus: int): LevelConfigurator
    + setObstacles(walls: int, hotTiles: int, campfires: int): LevelConfigurator
    + setEnemies(macetas: int, trolls: int, calamares: int): LevelConfigurator
}

' ============================================
' UTILIDADES
' ============================================

interface FruitCounter {
    + countCollectedFruits(): int
    + countTotalFruits(): int
}

class GameState {
    - currentLevelIndex: int
    - totalScore: int
    - levelScore: int
    - collectedFruits: int
    - remainingTime: long
    - playerLocation: SerializableLocation
    - player2Location: SerializableLocation
    - fruits: List<SerializableFruit>
    - enemies: List<SerializableEnemy>
    - timestamp: long
    + GameState(game: BadDopoCream)
    + toJson(): String
    + {static} fromJson(json: String): GameState
}

class IceBreaker {
    {static} + breakIceInDirection(level: Level, dx: int, dy: int): void
}

' ============================================
' EXCEPCIONES
' ============================================

class BadDopoCream_Exceptions {
    {static} + class GameInitializationException
    {static} + class LevelLoadException
    {static} + class InvalidLevelNumberException
    {static} + class MapSizeException
    {static} + class PlayerInitializationException
    {static} + class FruitCreationException
    {static} + class EnemyCreationException
    {static} + class InvalidPositionException
    {static} + class CollisionDetectionException
    {static} + class GameStateException
    {static} + class SaveGameException
    {static} + class LoadGameException
    {static} + class FileOperationException
    {static} + class JsonParseException
    {static} + class ConfigurationException
    {static} + class AIException
    {static} + class TimerException
    {static} + class ImageLoadException
    {static} + class UIComponentInitializationException
    {static} + class InvalidInputException
    {static} + class GameLogicException
}

' ============================================
' RELACIONES DE COMPOSICIÓN
' ============================================

BadDopoCream "1" *-- "1..*" Level : contiene
BadDopoCream ..|> FruitCounter : implementa

Level "1" *-- "1" Map : contiene
Level "1" *-- "1..2" IceCream : jugadores
Level "1" *-- "0..*" Fruit : frutas
Level "1" *-- "0..*" Enemy : enemigos

Map "1" *-- "0..*" IceWall : hielos
Map "1" *-- "0..*" BaldosaCaliente : baldosas
Map "1" *-- "0..*" Fogata : fogatas
Map "1" o-- "0..*" Location : paredes

IceCream "1" o-- "1" Location : posición
IceCreamAI "1" o-- "1" BadDopoCream : controla
IceCreamAI "1" -- "1" AIProfile : usa perfil

' ============================================
' RELACIONES DE HERENCIA - FRUTAS
' ============================================

Fruit <|-- Banana
Fruit <|-- Cherry
Fruit <|-- Grapes
Fruit <|-- Pineapple
Fruit <|-- Cactus

Fruit "1" o-- "1" Location : posición
Cherry "1" o-- "0..1" Map : referencia
Pineapple "1" o-- "0..1" Map : referencia

' ============================================
' RELACIONES DE HERENCIA - ENEMIGOS
' ============================================

Enemy <|-- Maceta
Enemy <|-- Troll
Enemy <|-- CalamarNaranja
Enemy <|-- Calamar
Enemy <|-- Narval

Enemy "1" o-- "1" Location : posición

' ============================================
' RELACIONES DE OBSTÁCULOS
' ============================================

IceWall "1" o-- "1" Location : posición
BaldosaCaliente "1" o-- "1" Location : posición
Fogata "1" o-- "1" Location : posición

' ============================================
' RELACIONES DE CONSTRUCCIÓN
' ============================================

LevelBuilder ..> Level : construye
LevelBuilder ..> LevelConfigurator : usa
LevelBuilder ..> Map : configura
LevelBuilder ..> Fruit : crea
LevelBuilder ..> Enemy : crea

LevelConfigurator ..> Level : configura

' ============================================
' RELACIONES DE UTILIDADES
' ============================================

GameState ..> BadDopoCream : guarda estado
IceBreaker ..> Level : modifica hielo

' ============================================
' NOTAS
' ============================================

note top of BadDopoCream
  Clase principal del juego
  Gestiona niveles y puntaje total
end note

note top of Level
  Representa un nivel del juego
  Gestiona jugadores, frutas, enemigos
  Control de timer (3 minutos)
end note

note top of Map
  Representa el mapa del nivel
  Gestiona paredes, hielo y obstáculos
end note

note top of IceCreamAI
  Inteligencia artificial del jugador
  Tres perfiles: Hungry, Fearful, Expert
  Pathfinding y evasión de enemigos
end note

note bottom of Fruit
  Clase base abstracta para frutas
  Polimorfismo para comportamientos especiales
end note

note bottom of Enemy
  Clase base abstracta para enemigos
  Cada tipo tiene movimiento único
end note

note right of Fogata
  Se apaga 10s al romper hielo sobre ella
  Mata al jugador al contacto
end note

note right of BaldosaCaliente
  Derrite hielo instantáneamente
  Siempre activa
end note

note left of Cactus
  Tiene pinchos periódicos
  Mata al jugador si tiene pinchos
  300 puntos si se recolecta sin pinchos
end note

note left of Pineapple
  Única fruta empujable
  Se mueve con el jugador
  Vale 200 puntos
end note

note left of Cherry
  Se mueve aleatoriamente
  Requiere referencia al mapa
end note

@enduml
