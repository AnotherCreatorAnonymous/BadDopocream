@startuml Bad_Dopo_Cream_Domain

' ============================================
' DIAGRAMA DE CLASES DEL DOMINIO
' Bad Dopo Cream - DOPO 2025
' Última actualización: Diciembre 2025
' ============================================

skinparam classAttributeIconSize 0
skinparam backgroundColor #FEFEFE
skinparam class {
    BackgroundColor<<abstract>> LightYellow
    BackgroundColor<<interface>> LightCyan
    BackgroundColor<<enum>> LightPink
    BorderColor Black
    ArrowColor Black
}

' ============================================
' INTERFACES
' ============================================

interface IceBreaker <<interface>> {
    + breakIce(level: Level, x: int, y: int): void
}

interface Movable <<interface>> {
    + setMap(map: Map): void
    + getLocation(): Location
    + setLocation(location: Location): void
    + tryMove(dx: int, dy: int, map: Map): boolean
}

interface FruitCounter <<interface>> {
    + countCollectedFruits(): int
    + countTotalFruits(): int
}

' ============================================
' CLASE PRINCIPAL DEL JUEGO
' ============================================

class BadDopoCream {
    - levels: ArrayList<Level>
    - currentLevelIndex: int
    - currentLevel: Level
    - totalScore: int
    - gameWon: boolean
    - player1Score: int
    - player2Score: int
    + BadDopoCream()
    + startGame(): void
    + nextLevel(): void
    + getCurrentLevel(): Level
    + getCurrentLevelNumber(): int
    + getTotalScore(): int
    + getPlayer1Score(): int
    + getPlayer2Score(): int
    + addPlayer1Score(points: int): void
    + addPlayer2Score(points: int): void
    + isGameWon(): boolean
    + isGameOver(): boolean
    + isPaused(): boolean
    + pause(): void
    + resume(): void
    + resetToLevel(levelNumber: int): void
    + restoreFromState(state: GameState): void
    + saveGame(playerColor: String, gameMode: String, saveName: String): boolean
    + {static} loadGame(saveName: String): GameState
    + {static} listSavedGames(): List<String>
    + {static} deleteSavedGame(saveName: String): boolean
}

' ============================================
' NIVEL Y MAPA
' ============================================

class Level {
    - levelNumber: int
    - map: Map
    - player: IceCream
    - player2: IceCream
    - fruits: ArrayList<Fruit>
    - enemies: ArrayList<Enemy>
    - waves: ArrayList<FruitWave>
    - isCompleted: boolean
    - currentScore: int
    - levelStartTime: long
    - pausedTime: long
    - lastPauseStart: long
    - isPaused: boolean
    - timeExpired: boolean
    - useWaveSystem: boolean
    {static} - LEVEL_TIME_LIMIT: long = 180000
    + Level(levelNumber: int, width: int, height: int)
    + movePlayer(dx: int, dy: int): boolean
    + movePlayer2(dx: int, dy: int): boolean
    + moveEnemies(): void
    + moveFruits(): void
    + createIceLine(dx: int, dy: int): void
    + createIceLineForPlayer2(dx: int, dy: int): void
    + breakIceWall(location: Location): void
    + createIceLineFromPlayer(player: IceCream, dx: int, dy: int): void
    + breakIceLineFromPosition(startX: int, startY: int, dx: int, dy: int): void
    + hasEnemyAt(location: Location): boolean
    + isPlayerAt(location: Location): boolean
    + isCompleted(): boolean
    + isGameOver(): boolean
    + getRemainingTime(): long
    + pause(): void
    + resume(): void
    + isPaused(): boolean
    + getClosestPlayerLocation(enemyLocation: Location): Location
    + addWave(wave: FruitWave): void
    + enableWaveSystem(): void
    + getPlayerInfo(playerNum: int): PlayerInfo
    + getEnemyInfo(): List<EnemyInfo>
    + getFruitInfo(): List<FruitInfo>
    + getObstacleInfo(): List<ObstacleInfo>
}

class Map {
    - width: int
    - height: int
    - walls: ArrayList<Location>
    - iceWalls: ArrayList<IceWall>
    - hotTiles: ArrayList<BaldosaCaliente>
    - campfires: ArrayList<Fogata>
    + Map(width: int, height: int)
    + isValidPosition(location: Location): boolean
    + hasWall(location: Location): boolean
    + hasIceWall(location: Location): boolean
    + isHotTile(location: Location): boolean
    + isCampfireAt(location: Location): boolean
    + addWall(location: Location): void
    + addIceWall(location: Location): void
    + addIceWall(iceWall: IceWall): void
    + removeIceWall(location: Location): void
    + addHotTile(hotTile: BaldosaCaliente): void
    + addCampfire(campfire: Fogata): void
    + getCampfireAt(location: Location): Fogata
    + getIceWallAt(location: Location): IceWall
    + getIceWalls(): List<IceWall>
    + getHotTiles(): List<BaldosaCaliente>
    + getCampfires(): List<Fogata>
    + getWidth(): int
    + getHeight(): int
    + getRandomEmptyLocation(): Location
}

class Location {
    - x: int
    - y: int
    + Location(x: int, y: int)
    + getX(): int
    + getY(): int
    + move(dx: int, dy: int): Location
    + distanceTo(other: Location): double
    + manhattanDistanceTo(other: Location): int
    + isAdjacent(other: Location): boolean
    + equals(obj: Object): boolean
    + hashCode(): int
    + toString(): String
}

' ============================================
' JUGADOR Y AI
' ============================================

class IceCream {
    - location: Location
    - character: String
    - alive: boolean
    - lastDx: int
    - lastDy: int
    - map: Map
    + IceCream(location: Location, character: String)
    + move(dx: int, dy: int): void
    + getLocation(): Location
    + setLocation(location: Location): void
    + isAlive(): boolean
    + die(): void
    + revive(): void
    + getCharacter(): String
    + getLastDx(): int
    + getLastDy(): int
    + setMap(map: Map): void
    + tryMove(dx: int, dy: int, map: Map): boolean
    + breakIce(level: Level, x: int, y: int): void
}

class IceCreamAI {
    - profile: AIProfile
    - random: Random
    {static} - ENEMY_DETECTION_RANGE: double = 4.0
    {static} - ENEMY_DANGER_RANGE: double = 3.0
    {static} - FEARFUL_SAFE_DISTANCE: double = 6.0
    + IceCreamAI()
    + IceCreamAI(profile: AIProfile)
    + decideMove(level: Level, player: IceCream): int[]
    - decideHungryMove(level: Level, player: IceCream): int[]
    - decideFearfulMove(level: Level, player: IceCream): int[]
    - decideExpertMove(level: Level, player: IceCream): int[]
    - findNearestFruit(level: Level, player: IceCream): Fruit
    - findSafestFruit(level: Level, player: IceCream): Fruit
    - isSafeFromEnemies(level: Level, location: Location): boolean
    - getMoveTowardsTarget(player: IceCream, target: Location, level: Level): int[]
    - getSafestMove(level: Level, player: IceCream): int[]
    - getEnemyDangerLevel(level: Level, location: Location): double
}

enum AIProfile <<enum>> {
    HUNGRY
    FEARFUL
    EXPERT
}

' ============================================
' UTILIDADES AI
' ============================================

class PathFinder {
    {static} + findPath(start: Location, end: Location, map: Map): List<Location>
    {static} + getNextMove(start: Location, end: Location, map: Map): int[]
    {static} - reconstructPath(cameFrom: Map, current: Location): List<Location>
    {static} - heuristic(a: Location, b: Location): double
}

class EnemyAI {
    - profile: AIProfile
    - random: Random
    + EnemyAI()
    + EnemyAI(profile: AIProfile)
    + decideMove(level: Level, enemy: Enemy): int[]
    - decideHungryMove(level: Level, enemy: Enemy): int[]
    - decideCowardMove(level: Level, enemy: Enemy): int[]
    - decideExpertMove(level: Level, enemy: Enemy): int[]
}

' ============================================
' FRUTAS (JERARQUÍA)
' ============================================

abstract class Fruit <<abstract>> {
    # name: String
    # points: int
    # location: Location
    # collected: boolean
    # canMove: boolean
    + Fruit(name: String, points: int, location: Location, canMove: boolean)
    + collect(): int
    + isCollected(): boolean
    + getLocation(): Location
    + setLocation(location: Location): void
    + getName(): String
    + getPoints(): int
    + move(): void
    + update(): void
    + canMove(): boolean
    + getTypeName(): String
    + pushByPlayer(dx: int, dy: int, playerLocation: Location): void
    + hasSpikes(): boolean
    + shouldKillPlayer(playerLocation: Location): boolean
    + requiresMapReference(): boolean
}

class Grapes {
    {static} - GRAPES_POINTS: int = 50
    + Grapes(location: Location)
    + collect(): int
    + getTypeName(): String
}

class Banana {
    {static} - BANANA_POINTS: int = 100
    + Banana(location: Location)
    + collect(): int
    + getTypeName(): String
}

class Cherry {
    {static} - CHERRY_POINTS: int = 150
    {static} - TELEPORT_INTERVAL: long = 20000
    - map: Map
    - lastTeleportTime: long
    + Cherry(location: Location)
    + setMap(map: Map): void
    + update(): void
    - teleport(): void
    + getTypeName(): String
    + requiresMapReference(): boolean
}

class Pineapple {
    {static} - PINEAPPLE_POINTS: int = 200
    - map: Map
    - random: Random
    - currentDx: int
    - currentDy: int
    + Pineapple(location: Location)
    + setMap(map: Map): void
    + collect(): int
    + move(): void
    - chooseRandomDirection(): void
    + pushByPlayer(dx: int, dy: int, playerLocation: Location): void
    + getTypeName(): String
    + requiresMapReference(): boolean
    + tryMove(dx: int, dy: int, map: Map): boolean
}

class Cactus {
    {static} - CACTUS_POINTS: int = 250
    {static} - SPIKE_INTERVAL: long = 30000
    - hasSpikes: boolean
    - lastSpikeToggle: long
    + Cactus(location: Location)
    + collect(): int
    + update(): void
    + hasSpikes(): boolean
    + shouldKillPlayer(playerLocation: Location): boolean
    + getSecondsUntilSpikeToggle(): int
    + getTypeName(): String
}

class FruitWave {
    - fruitType: String
    - points: int
    - fruits: List<Fruit>
    - activated: boolean
    + FruitWave(fruitType: String, points: int)
    + addFruit(fruit: Fruit): void
    + getFruits(): List<Fruit>
    + isActivated(): boolean
    + activate(): void
    + getFruitType(): String
    + getPoints(): int
}

' ============================================
' ENEMIGOS (JERARQUÍA)
' ============================================

abstract class Enemy <<abstract>> {
    # location: Location
    # name: String
    # map: Map
    # lastDx: int
    # lastDy: int
    + Enemy(location: Location, name: String)
    + getLocation(): Location
    + setLocation(location: Location): void
    + getName(): String
    + getLastDx(): int
    + getLastDy(): int
    + setMap(map: Map): void
    + collidesWithPlayer(playerLocation: Location): boolean
    + tryMove(playerLocation: Location, map: Map): void
    {abstract} + move(playerLocation: Location, map: Map): void
}

class Troll {
    - dx: int
    - dy: int
    + Troll(location: Location)
    + move(playerLocation: Location, map: Map): void
    - reverseDirection(): void
}

class Maceta {
    + Maceta(location: Location)
    + move(playerLocation: Location, map: Map): void
    - moveTowardsPlayer(playerLocation: Location, map: Map): void
}

abstract class Calamar <<abstract>> {
    + Calamar(location: Location)
    + breakIce(level: Level, x: int, y: int): void
}

class CalamarNaranja {
    {static} - DETECTION_RANGE: double = 8.0
    - breakingIce: boolean
    - breakStartTime: long
    {static} - ICE_BREAK_DELAY: long = 500
    + CalamarNaranja(location: Location)
    + move(playerLocation: Location, map: Map): void
    - chasePlayer(playerLocation: Location, map: Map, level: Level): void
    + isBreakingIce(): boolean
}

class Narval {
    - state: NarvalState
    - chargeDirectionX: int
    - chargeDirectionY: int
    - detectionRange: int
    - chargeSpeed: int
    + Narval(location: Location)
    + move(playerLocation: Location, map: Map): void
    - patrol(map: Map): void
    - checkForChargeOpportunity(playerLocation: Location): void
    - charge(map: Map): void
    + isCharging(): boolean
    + breakIce(level: Level, x: int, y: int): void
}

enum NarvalState <<enum>> {
    PATROLLING
    CHARGING
    BREAKING_ICE
}

' ============================================
' OBSTÁCULOS
' ============================================

class IceWall {
    - location: Location
    - isBroken: boolean
    + IceWall(location: Location)
    + breakWall(): void
    + isBroken(): boolean
    + getLocation(): Location
    + isAt(location: Location): boolean
}

class BaldosaCaliente {
    - location: Location
    + BaldosaCaliente(location: Location)
    + getLocation(): Location
    + shouldMeltIce(iceLocation: Location): boolean
}

class Fogata {
    - location: Location
    - lit: boolean
    - extinguishTime: long
    {static} - RELIGHT_DELAY: long = 10000
    + Fogata(location: Location)
    + getLocation(): Location
    + isLit(): boolean
    + extinguish(): void
    + forceRelight(): void
    + shouldKillPlayer(playerLocation: Location): boolean
}

' ============================================
' BUILDERS Y CONFIGURADORES
' ============================================

class LevelBuilder {
    - levelNumber: int
    - width: int
    - height: int
    - player1: IceCream
    - player2: IceCream
    - numGrapes: int
    - numBananas: int
    - numCherries: int
    - numPineapples: int
    - numCactus: int
    - numMacetas: int
    - numTrolls: int
    - numCalamares: int
    - numNarvales: int
    - numIceWalls: int
    - numCampfires: int
    - numHotTiles: int
    - useWaves: boolean
    + LevelBuilder(levelNumber: int)
    + setMapSize(width: int, height: int): LevelBuilder
    + setPlayer1(player: IceCream): LevelBuilder
    + setPlayer2(player: IceCream): LevelBuilder
    + setGrapes(count: int): LevelBuilder
    + setBananas(count: int): LevelBuilder
    + setCherries(count: int): LevelBuilder
    + setPineapples(count: int): LevelBuilder
    + setCactus(count: int): LevelBuilder
    + setMacetas(count: int): LevelBuilder
    + setTrolls(count: int): LevelBuilder
    + setCalamares(count: int): LevelBuilder
    + setNarvales(count: int): LevelBuilder
    + setIceWalls(count: int): LevelBuilder
    + setCampfires(count: int): LevelBuilder
    + setHotTiles(count: int): LevelBuilder
    + enableWaveSystem(): LevelBuilder
    + build(): Level
    - addFruitsOfType(level: Level, positions: List<Location>, count: int, creator: Function<Location, Fruit>): void
    - addEnemiesOfType(level: Level, positions: List<Location>, count: int, creator: Function<Location, Enemy>): void
}

class LevelConfigurator {
    + {static} createLevel(levelNumber: int, player: IceCream): Level
    + {static} createLevel(levelNumber: int, player1: IceCream, player2: IceCream): Level
    + {static} createDefaultLevel1(player: IceCream): Level
    + {static} createDefaultLevel2(player: IceCream): Level
    + {static} createDefaultLevel3(player: IceCream): Level
}

' ============================================
' DTOs / INFO CLASSES
' ============================================

class PlayerInfo {
    + x: int
    + y: int
    + character: String
    + isAlive: boolean
    + lastDx: int
    + lastDy: int
    + name: String
    + color: String
    + PlayerInfo(x: int, y: int, character: String, isAlive: boolean, lastDx: int, lastDy: int, name: String, color: String)
}

class FruitInfo {
    + x: int
    + y: int
    + typeName: String
    + name: String
    + isCollected: boolean
    + hasSpikes: boolean
    + secondsUntilSpike: int
    + FruitInfo(x: int, y: int, typeName: String, name: String, isCollected: boolean, hasSpikes: boolean, secondsUntilSpike: int)
}

class EnemyInfo {
    + x: int
    + y: int
    + typeName: String
    + lastDx: int
    + lastDy: int
    + isCharging: boolean
    + isBreakingIce: boolean
    + EnemyInfo(x: int, y: int, typeName: String, lastDx: int, lastDy: int, isCharging: boolean, isBreakingIce: boolean)
}

class ObstacleInfo {
    + x: int
    + y: int
    + type: String
    + isActive: boolean
    + ObstacleInfo(x: int, y: int, type: String, isActive: boolean)
}

' ============================================
' PERSISTENCIA
' ============================================

class GameState {
    - saveName: String
    - playerColor: String
    - gameMode: String
    - levelNumber: int
    - totalScore: int
    - player1Score: int
    - player2Score: int
    - timestamp: long
    + GameState()
    + getSaveName(): String
    + getPlayerColor(): String
    + getGameMode(): String
    + getLevelNumber(): int
    + getTotalScore(): int
    + getPlayer1Score(): int
    + getPlayer2Score(): int
    + getTimestamp(): long
    + setSaveName(name: String): void
    + setPlayerColor(color: String): void
    + setGameMode(mode: String): void
    + setLevelNumber(level: int): void
    + setTotalScore(score: int): void
}

class HighScoreManager {
    {static} - HIGHSCORES_FILE: String
    {static} - MAX_HIGHSCORES: int = 10
    - highScores: List<HighScoreEntry>
    + HighScoreManager()
    + addHighScore(name: String, score: int, gameMode: String, level: int): void
    + getHighScores(): List<HighScoreEntry>
    + isHighScore(score: int): boolean
    + getPositionForScore(score: int): int
    - loadHighScores(): void
    - saveHighScores(): void
}

class HighScoreEntry {
    - name: String
    - score: int
    - gameMode: String
    - level: int
    - timestamp: long
    + HighScoreEntry(name: String, score: int, gameMode: String, level: int)
    + getName(): String
    + getScore(): int
    + getGameMode(): String
    + getLevel(): int
    + getTimestamp(): String
}

' ============================================
' EXCEPCIONES
' ============================================

class BadDopoCream_Exceptions {
    + {static} class InvalidMoveException
    + {static} class LevelNotLoadedException
    + {static} class GameOverException
    + {static} class SaveLoadException
    + {static} class InvalidConfigurationException
}

' ============================================
' RELACIONES DE IMPLEMENTACIÓN
' ============================================

IceCream ..|> IceBreaker
IceCream ..|> Movable
Pineapple ..|> Movable
Enemy ..|> Movable
Calamar ..|> IceBreaker
Narval ..|> IceBreaker
BadDopoCream ..|> FruitCounter

' ============================================
' RELACIONES DE COMPOSICIÓN
' ============================================

BadDopoCream "1" *-- "1..*" Level : contiene
Level "1" *-- "1" Map : contiene
Level "1" *-- "1..2" IceCream : jugadores
Level "1" *-- "0..*" Fruit : frutas
Level "1" *-- "0..*" Enemy : enemigos
Level "1" *-- "0..*" FruitWave : oleadas

Map "1" *-- "0..*" IceWall : hielos
Map "1" *-- "0..*" BaldosaCaliente : baldosas
Map "1" *-- "0..*" Fogata : fogatas
Map "1" o-- "0..*" Location : paredes

HighScoreManager "1" *-- "0..*" HighScoreEntry : entradas

' ============================================
' RELACIONES DE HERENCIA - FRUTAS
' ============================================

Fruit <|-- Grapes
Fruit <|-- Banana
Fruit <|-- Cherry
Fruit <|-- Pineapple
Fruit <|-- Cactus

' ============================================
' RELACIONES DE HERENCIA - ENEMIGOS
' ============================================

Enemy <|-- Troll
Enemy <|-- Maceta
Enemy <|-- Calamar
Calamar <|-- CalamarNaranja
Enemy <|-- Narval

' ============================================
' RELACIONES DE ASOCIACIÓN
' ============================================

IceCreamAI "1" -- "1" AIProfile : usa
EnemyAI "1" -- "1" AIProfile : usa
Narval "1" -- "1" NarvalState : estado

IceCream "1" o-- "1" Location : posición
Fruit "1" o-- "1" Location : posición
Enemy "1" o-- "1" Location : posición
IceWall "1" o-- "1" Location : posición
BaldosaCaliente "1" o-- "1" Location : posición
Fogata "1" o-- "1" Location : posición

Cherry "1" o-- "0..1" Map : referencia
Pineapple "1" o-- "0..1" Map : referencia

' ============================================
' RELACIONES DE USO
' ============================================

LevelBuilder ..> Level : construye
LevelBuilder ..> Fruit : crea
LevelBuilder ..> Enemy : crea
LevelConfigurator ..> LevelBuilder : usa
PathFinder ..> Map : navega
GameState ..> BadDopoCream : guarda/restaura

' ============================================
' NOTAS
' ============================================

note top of BadDopoCream
  **Fachada principal del juego**
  - Gestiona niveles y puntaje
  - Soporta 1 o 2 jugadores
  - Persistencia de partidas
end note

note top of Level
  **Representa un nivel del juego**
  - Timer de 3 minutos
  - Sistema de oleadas de frutas
  - Soporte multiplayer
end note

note right of IceCreamAI
  **IA del helado (jugador máquina)**
  - Hungry: busca frutas
  - Fearful: evita enemigos
  - Expert: balance óptimo
end note

note bottom of Fruit
  **Jerarquía de frutas**
  Puntos: Grapes(50) < Banana(100)
  < Cherry(150) < Pineapple(200)
  < Cactus(250)
end note

note right of Narval
  **Comportamiento de embestida**
  - Patrulla normalmente
  - Embiste al alinearse con jugador
  - Destruye hielo en su camino
end note

note right of Fogata
  **Se apaga temporalmente**
  - Crear hielo sobre ella y romperlo
  - Se reenciende en 10 segundos
end note

@enduml
